From ceef9a5923e1fad2dc1c73d09bd76eb9e4bd93ff Mon Sep 17 00:00:00 2001
From: Miroslav Ondra <ondra@faster.cz>
Date: Thu, 9 Sep 2021 20:04:39 +0200
Subject: [PATCH 03/10] Add Microchip EERAM support into spi-nor

---
 drivers/mtd/spi-nor/Makefile    |  1 +
 drivers/mtd/spi-nor/core.c      |  5 +++++
 drivers/mtd/spi-nor/core.h      |  1 +
 drivers/mtd/spi-nor/microchip.c | 22 ++++++++++++++++++++++
 4 files changed, 29 insertions(+)
 create mode 100644 drivers/mtd/spi-nor/microchip.c

diff --git a/drivers/mtd/spi-nor/Makefile b/drivers/mtd/spi-nor/Makefile
index 653923896..11616f6f6 100644
--- a/drivers/mtd/spi-nor/Makefile
+++ b/drivers/mtd/spi-nor/Makefile
@@ -11,6 +11,7 @@ spi-nor-objs			+= gigadevice.o
 spi-nor-objs			+= intel.o
 spi-nor-objs			+= issi.o
 spi-nor-objs			+= macronix.o
+spi-nor-objs			+= microchip.o
 spi-nor-objs			+= micron-st.o
 spi-nor-objs			+= spansion.o
 spi-nor-objs			+= sst.o
diff --git a/drivers/mtd/spi-nor/core.c b/drivers/mtd/spi-nor/core.c
index 06e1bf01f..f06ddc6ed 100644
--- a/drivers/mtd/spi-nor/core.c
+++ b/drivers/mtd/spi-nor/core.c
@@ -2019,6 +2019,7 @@ static const struct spi_nor_manufacturer *manufacturers[] = {
 	&spi_nor_intel,
 	&spi_nor_issi,
 	&spi_nor_macronix,
+	&spi_nor_microchip,
 	&spi_nor_micron,
 	&spi_nor_st,
 	&spi_nor_spansion,
@@ -3433,6 +3434,10 @@ static const struct spi_device_id spi_nor_dev_ids[] = {
 	{ "mr25h10" },  /*   1 Mib, 40 MHz */
 	{ "mr25h40" },  /*   4 Mib, 40 MHz */
 
+    /* Microchip 512-Kbit/1-Mbit SPI Serial EERAM 48L512/48LM01 */
+    { "me48l512" }, /* 512 Kib 66 MHz */
+    { "me48lm01" },  /* 1 Mib 66 MHz */
+
 	{ },
 };
 MODULE_DEVICE_TABLE(spi, spi_nor_dev_ids);
diff --git a/drivers/mtd/spi-nor/core.h b/drivers/mtd/spi-nor/core.h
index 6f62ee861..000b124dd 100644
--- a/drivers/mtd/spi-nor/core.h
+++ b/drivers/mtd/spi-nor/core.h
@@ -391,6 +391,7 @@ extern const struct spi_nor_manufacturer spi_nor_gigadevice;
 extern const struct spi_nor_manufacturer spi_nor_intel;
 extern const struct spi_nor_manufacturer spi_nor_issi;
 extern const struct spi_nor_manufacturer spi_nor_macronix;
+extern const struct spi_nor_manufacturer spi_nor_microchip;
 extern const struct spi_nor_manufacturer spi_nor_micron;
 extern const struct spi_nor_manufacturer spi_nor_st;
 extern const struct spi_nor_manufacturer spi_nor_spansion;
diff --git a/drivers/mtd/spi-nor/microchip.c b/drivers/mtd/spi-nor/microchip.c
new file mode 100644
index 000000000..121322c39
--- /dev/null
+++ b/drivers/mtd/spi-nor/microchip.c
@@ -0,0 +1,22 @@
+// SPDX-License-Identifier: GPL-2.0
+/*
+ * Copyright (C) 2005, Intec Automation Inc.
+ * Copyright (C) 2014, Freescale Semiconductor, Inc.
+ * Copyright (C) 2021, Faster CZ. spol. s r.o.
+ */
+
+#include <linux/mtd/spi-nor.h>
+
+#include "core.h"
+
+static const struct flash_info microchip_parts[] = {
+    /* Microchip 512-Kbit/1-Mbit SPI Serial EERAM 48L512/48LM01 */
+    { "me48l512",  CAT25_INFO( 64 * 1024, 1, 256, 3, SPI_NOR_NO_ERASE | SPI_NOR_NO_FR | SPI_NOR_HAS_LOCK) },
+    { "me48lm01",  CAT25_INFO(128 * 1024, 1, 256, 3, SPI_NOR_NO_ERASE | SPI_NOR_NO_FR | SPI_NOR_HAS_LOCK) },
+};
+
+const struct spi_nor_manufacturer spi_nor_microchip = {
+	.name = "microchip",
+	.parts = microchip_parts,
+	.nparts = ARRAY_SIZE(microchip_parts),
+};
-- 
2.20.1

